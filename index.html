<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
</head>
<body>

<div id="container">
</div>

<!-- Templates -->
<script id="panel-template" type="text/x-handlebars-template">
  <div class="panel panel-default">
    <div class="panel-heading" data-toggle="collapse" data-target="#panel{{@index}}">
      <h4 class="panel-title">
        {{title}}
      </h4>
    </div>
    <div id="panel{{@index}}" class="panel-collapse collapse {{expand @index}}">
      <div class="panel-body">
        {{description}}

        <form action="{{action}}" data-validator="{{validator}}">
          {{#each modules}}
            {{> (chooseTemplate)}}
          {{/each}}

          <button type="submit" class="next">Next</button>
        </form>
      </div>
    </div>
  </div>
</script>

<script id="list-template" type="text/x-handlebars-template">
  <div class="panel panel-default">
    <div class="panel-heading" data-toggle="collapse" data-target="#panel{{@index}}">
      <h4 class="panel-title">
        {{title}}
      </h4>
    </div>
    <div id="panel{{@index}}" class="panel-collapse collapse {{expand @index}}">
      <div class="panel-body">
        <ul class="list-group">
          {{#each items}}
            <li class="list-group-item">{{this}}</li>
          {{/each}}
        </ul>
      </div>
    </div>
  </div>
</script>

<script id="main-template" type="text/x-handlebars-template">
  <div class="alert alert-success alert-dismissible" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    {{info}}
  </div>
  <div class="panel-group" id="accordion">
    {{#each panels}}
      {{> (chooseTemplate)}}
    {{/each}}
  </div>
</script>

<script id="input-template" type="text/x-handlebars-template">
  <div class="form-group">
    <label for="{{name}}">{{label}}</label>
    <input type="{{type}}" class="form-control" data-validates-length="9" name="{{name}}" placeholder="{{placholder}}" />
  </div>
</script>

<script id="link-template" type="text/x-handlebars-template">
  <a href="{{url}}">{{name}}</a>
</script>

<script id="job-template" type="text/x-handlebars-template">
  <div class="checkbox">
    <label>
      <img src="{{image}}" width="75" height="75" />
      {{description}}
      <input type="checkbox" name="{{name}}"> {{title}}
    </label>
  </div>
</script>

<script id="radio-template" type="text/x-handlebars-template">
  <div class="checkbox">
    <label>
      {{title}}
      <input type="radio" name="{{name}}" value="{{value}}"> {{description}}
    </label>
  </div>
</script>

<script id="error-template" type="text/x-handlebars-template">
  <div class="alert alert-danger" role="alert">{{message}}</div>
</script>

<script type="text/javascript">
  var context = {
    info: "Welcome!",
    panels: [
      {
        title: "Social",
        description: "Add your social",
        action: "/submit/ssn",
        modules:[
          {
            label: "Add your SSN",
            type: "input",
            name: "ssn",
            placeholder: "000-00-0000",
            template: 'input'
          },
          {
            url: 'http://google.com',
            name: 'Google',
            template: 'link'
          },
          {
            url: 'http://yahoo.com',
            name: 'Yahoo',
            template: 'link'
          },
          {
            url: 'http://twitter.com',
            name: 'Twitter',
            template: 'link'
          }
        ],
        template: 'panel'
      },
      {
        title: "Jobs",
        description: "Select a job",
        action: "/submit/jobs",
        validator: "jobs",
        modules:[
          {
            title: 'Postmates',
            image: 'https://pbs.twimg.com/profile_images/615529697225523200/Z_CrdVi0_400x400.png',
            description: 'join Postmates!!!',
            name: 'postmates',
            template: 'job'
          },
          {
            title: 'Uber',
            image: 'https://pbs.twimg.com/profile_images/616424605218025472/qISsGgP9_400x400.png',
            description: 'join Uber!!!',
            name: 'uber',
            template: 'job'
          },
          {
            url: 'http://google.com',
            name: 'Google',
            template: 'link'
          },
          {
            url: 'http://yahoo.com',
            name: 'Yahoo',
            template: 'link'
          },
          {
            url: 'http://twitter.com',
            name: 'Twitter',
            template: 'link'
          }
        ],
        template: 'panel'
      },
      {
        title: "Onboarding",
        description: "Select an orientation time",
        action: "/submit/orientation-time",
        modules:[
          {
            title: 'Monday',
            description: '3pm',
            name: 'orientation',
            value: 'monday',
            template: 'radio'
          },
          {
            title: 'Wednesday',
            description: '2pm',
            name: 'orientation',
            value: 'wednesday',
            template: 'radio'
          },
          {
            title: 'Friday',
            description: '3pm',
            name: 'orientation',
            value: 'friday',
            template: 'radio'
          },
          {
            url: 'http://google.com',
            name: 'Google',
            template: 'link'
          },
          {
            url: 'http://yahoo.com',
            name: 'Yahoo',
            template: 'link'
          },
          {
            url: 'http://twitter.com',
            name: 'Twitter',
            template: 'link'
          }
        ],
        template: 'panel'
      }
    ]
  };
</script>

<script type="text/javascript">
  Handlebars.registerHelper('chooseTemplate', function() {
    return this.template + '-template';
  });

  Handlebars.registerHelper('expand', function(index) {
    return index < 1 ? "in" : "";
  });
  var source = $("#main-template").html();
  var partials = [
      {name: "panel-template", html: $("#panel-template").html()},
      {name: "list-template", html: $("#list-template").html()},
      {name: "input-template", html: $("#input-template").html()},
      {name: "link-template", html: $("#link-template").html()},
      {name: "job-template", html: $("#job-template").html()},
      {name: "radio-template", html: $("#radio-template").html()},
      {name: "error-template", html: $("#error-template").html()}
  ];
  var templates = partials.map(function (partial) { return Handlebars.registerPartial(partial.name, partial.html); });
  var template = Handlebars.compile(source);
  var html = template(context);
  var container = $('#container');
  container.html(html);

  //Event Listeners
  var is_valid = true;
  var validation_message = "";
  container.on('click','.next',function(e){
    e.preventDefault();
    var elem = $(this);
    var form = elem.parents('form').first();
    var panel = elem.parents('.panel').first();
    var next = panel.next('.panel');
    var data = form.serialize();
    panel.addClass('panel-success');


    panel.find('input').each(function(e){
      var elem = $(this);
      if(elem.data('validates-length')){
        if(elem.data('validates-length') != elem.val().length){
          console.log('not valid');
          var parent = elem.parents('.form-group').first();
          parent.addClass('has-error');
          //var label = parent.find('label').text();
          parent.find('label').text("SSN (must have "+elem.data('validates-length')+" characters)");
          is_valid = false;
        }
      }
    });

    if(form.data('validator')){
      validator.jobs(form);
    }

    if(is_valid){
      panel.find('.panel-collapse').collapse('toggle');
      next.find('.panel-collapse').collapse('toggle');
      console.log(data);
    }else{
      var parent = elem.parents('.form-group').first();
      parent.addClass('has-error');
      var source = $("#error-template").html();
      var template = Handlebars.compile(source);
      var html = template({message:validation_message});
      panel.append(html);
    }
  });
</script>

<script>
  var validator = {
    jobs: function(form){
      console.log('validating jobs');
      var jobs_checked = form.find('input:checked').length;
      if(jobs_checked > 5){
        is_valid = false;
        validation_message = "You can only select 5 jobs."
      }
      if(jobs_checked < 1){
        is_valid = false;
        validation_message = "You must select at least 1 job."
      }
    }
  }
</script>
</body>
</html>
